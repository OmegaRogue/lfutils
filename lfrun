#!/bin/sh
# run lf with support for ueberzug image previews and lflast.

# config
tmp="${XDG_RUNTIME_DIR:-/tmp}/lf"
export FIFO="$tmp/fifo-$$"

main()
{
    case "$1" in
        -remote|-doc|-version|-server|-help)
            lf "$@"
            return
        ;;
    esac

    mkdir -p "$tmp"
    preview_init
    lf -last-dir-path="$tmp/lastdir" "$@"
}

preview_init()
{
    [ -z "$DISPLAY" ] && return 1
    command -v ueberzug >/dev/null || return 1
    trap cleanup EXIT
    (
        setup() {
            rm -f "$FIFO"
            mkfifo "$FIFO" || return 1
            sleep inf > "$FIFO" &
            ueberzug layer -s < "$FIFO"
        }
        trap setup USR1
        while true; do
            sleep inf &
            wait
        done
    ) &
    export SHPID=$!
}

cleanup()
{
    rm -f "$FIFO"
    pkill -g0
}

main "$@"
