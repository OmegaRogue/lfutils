#!/bin/sh
# run lf with support for ueberzug image previews and lflast.

# config
tmp="${XDG_RUNTIME_DIR:-/tmp}/lf"
export PREVIEW_STATE="$tmp/$$/preview-state"
export PREVIEW_FIFO="$tmp/$$/preview-fifo"
export PREVIEW_PID="$tmp/$$/preview-pid"
export SHELL_FIFO="$tmp/$$/shell-fifo"

main()
{
    case "$1" in
        -remote|-doc|-version|-server|-help)
            lf "$@"
            return
        ;;
    esac

    trap 'rm -rf "$tmp/$$"; pkill -P $$' EXIT
    rm -rf "$tmp/$$"
    mkdir -p "$tmp/$$"
    ueberzug_init
    lf -last-dir-path="$tmp/lastdir" "$@"
}

ueberzug_init()
{
    [ -z "$DISPLAY" ] && return 1
    command -v ueberzug >/dev/null || return 1

    mkfifo "$PREVIEW_FIFO" || return 1
    mkfifo "$SHELL_FIFO" || return 1

    sleep inf > "$PREVIEW_FIFO" &
    sleep inf > "$SHELL_FIFO" &

    sh < "$SHELL_FIFO" &
}

main "$@"
